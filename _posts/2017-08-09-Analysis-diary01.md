---
layout: post
title: "물꼬기의 수상한 Analysis 일지 01 - 3.4 DDoS(1)"
date: 2017-08-09
author: conchi
categories: Malware Analysis
---

쟈란쟈란!    
오늘부터는 지난번에 소개했던 사건사고들에 사용되었던    
악성코드들을 분석한 소소한 보고서를 올려볼까한다 'ㅅ'//   
역시나 내 마음대로 쓰는 글이기 때문에 무슨말을 할지는 나도모르겠땅  
<br>

![1](/assets/ana01/01.jpg)  
- - -

두근거리는 마음으로 샘플을 확인해보자.   
는 바이너리가 절랭 많은데 뭘 봐야하는거지 'ㅅ'a;;;..   
(혼란)  
<br>
모가 해쉬값을 이름으로 가진 파일들이 겁나 많음..  
뭐부터 봐야할지 몰라서 해쉬파일 이름 앞에 그럴싸한 파일명이 있는   
몇몇의 놈들을 분석하기로 했다.  
<br>
<br>

##host.dll  
- MD5 : 0a21b996e1f875d740034d250b878884    
- SHA256 : f09dae150921aa57673a0f1737f9c384399dcf1987eb735cef0111ea1ba3c895   

한줄요약 : 이 녀석은 드로퍼같이 생긴 녀석이다.  
<br>
<br>

![2](/assets/ana01/02.jpg)  
<br>
<br>

나는 IDA에 의존적인 닝겐이기 때문에 바이너리를 받자마자 IDA에 넣는 습성을 가지고 있다    
(다른 디버거/디스어셈블러를 싫어하거나 사용하지 않는건 아니지만 뭔가 숨쉬는 것 처럼 나도 모르게 이러고 있다).   
DLL이 가지고 있는 특성상 export table을 먼저 확인하였다.   
역시나 DllEntryPoint가 존재했고, 조금 특이하게 StartInstall이라는 부분이 보였다.   
이 둘을 중점으로 분석하기 시작했다.  

![6](/assets/ana01/06.jpg)  
<br>

는 DllEntryPoint는 IDA가 잡아준듯.. 원래는 StartInstall 하나밖에 없나봉가.. 'ㅅ'a...  
감사감사      
<br>
<br>

#### 01. StartInstall  
함수자체는 그리 복잡하지 않다. 두개의 함수를 call하고 어딘가로 jmp하는 모습을 볼 수 있었는데   
이 함수들의 안은 혼돈 그자체였다. 보자마자 IDA를 끄고 30초간 들숨날숨 한 후 분석하기 시작했다.     
<br>

**첫번째 함수, sub_100025E0**  
이 함수 안으로 들어가면 제일먼저 보이는건 System32의 디렉토리 경로를 구한 후,
sprintf로 drivers\etc\hosts파일에 무언가를 쓰는 부분이다.   
뭘 쓰고있나 아래쪽을 분석했더니 "127. 0.0.1 %s"라고 되있는 부분을 발견할 수 있었는데,
이 %s에 들어가는 내용은 ㅜ_ㅜ.. 어떻게 찾아야하지..     
<br>

는 바이너리 보자마자 제일먼저 Strings Window할 때 봤던 백신회사들의 업데이트 사이트 주소인듯 하다.     
<br>

![3](/assets/ana01/03.jpg)  
<br>
쭉 내려보다가 얘들이 왜 여기있지?   
했는데 hosts파일을 변조해서 사용자가 백신이나 악성코드를 제거하기 위해 하는 동작들을 막기위해   
넣어둔게 아닐까 생각된다(치밀함에 소름돋아버림)    
<br>
![15](/assets/ana01/15.png)    
<br>
실화였다. 이렇게 hosts 파일이 바뀜  

<br>

**두번째 함수, sub_10002140**
여기서는 여러개의 파일이 만들어진다. 만들어지는 파일은 다음과 같다.  
- faultrep.dat   
- tlntwye.dat   
- tljoqgv.dat   
- noise03.dat   
- 그리고 의문의 3개의 dll  
<br>

![16](/assets/ana01/16.jpg)     
<br>

dll을 생성하는것으로 추측되는 함수로 들어가면   `SystemRoot\System32`아래에 생성되며,    
`SYSTEM\CurrentControlSet\Services` 레지스트리에 서비스로 등록시킨다. *골때린다진짜.*     
<br>

여기에서 ``%SystemRoot%\\system32\\svchost.exe -k [생성되는dll]``   
이런 부분도 볼 수 있는데 하도 궁금해서 찾아보니 부팅 시 해당 dll이 실행된다는 의미인듯 하다.   
서비스로 등록시켜 만수무강시키겠다는 악성코드 제작자의 장수 의지가 엿보이는 부분이다.   
지난 7.7 DDoS 샘플에서도 본인을 Service에 등록시키는 모습을 봤었던것 같은데...   
생존본능이란 이런건가 싶기도 하다.  
<br>

![4](/assets/ana01/04.jpg)    
- CreateService 하는 부분
<br>

![5](/assets/ana01/05.jpg)    
- Openservice하고 StartService하는 부분
<br>

내일은 생성된 7개의 파일을 중점으로 분석해봐야 할 듯 하다.   
흥미진진한 하루가 되겠구먼 'ㅅ'a;;...  
<br>
<br>

**마지막 함수, sub_1002440**  
우리의 코드는 두개의 큰 함수 덩어리들을 지나고나면 어디론가 황급히 jmp하게된다.  
그곳에는 자가삭제를 위한 배치파일을 생성하는 코드들이 존재했다.  
<br>
<br>

- - -
분석하는데는 시간이 꽤 걸렸는데 적고나니 뭐가 없어서 기분이 몹시 슬프다. 뭐때문인지 dll이 제대로   
동작하지 않아 원하는 모습을 보지 못해 더더 슬픈것 같다.   
흑흑.. 내 가상머신 mbr이고 뭐고 다 부셔도 좋으니 돌아가란말이다(쾅쾅)   
<br>

헥스레이를 거의 사용하지 않고 하는 첫 분석인듯하다.   
그동안 헥스레이충에 가까운 분석을 해왔는데 오히려 어셈이 더 깔끔하고(?) 직관적인 터라 코드를   
이해하는데 시간이 덜 걸렸던 것 같다 .  
그래프와 함께 사용하니 함수의 루틴이나 이동을 파악하는데 훨씬 편했던것 같다.   
<br>

그래서 Host.dll의 기능을 요약해보자면  

- hosts파일을 변조함 (백신이나 본인(악성코드)을 위협할만한 것들을 사전 차단하기 위한 수작으로보인다)  
- 수상한 냄새를 폴폴 풍기는 여러개의 파일들을 만들고, 생성된 DLL들은 서비스로 등록시키고 서비스를 실행한다.  
<br>

이쯤 되는거같다. 흑흑..    
내일은 수상한 바이너리들을 분석한 글로 다시 나타나야징   
수고링-    

- - -
+) host.dll에서 바로 hosts 파일을 변조하는 놈이 있고, host.dll에서 떨어트리는 다른 바이너리가     
hosts파일을 변조하는 놈도 있다고 한다.   
host.dll이라는 이름이 아니고 nt모시기 저시기인놈도 있으니 참고들 하시라 'ㅅ'/    

+) host.dll의 StartInstall은  ollydbg에 기본적으로 로드되어있는 dll로더로 로드가 되지 않더이다.. ㅜㅜ..  
(계속 DllMain이 있는곳으로 로드되어버림 ㅜㅜ..)  
그래서 rundll32.exe에 붙여서 강제로 StartInstall을 로드시켰당.  

딩딩 수고링 'ㅅ'/  
