---
layout: post
title: "물꼬기의 수상한 Analysis 일지 01 - 3.4 DDoS(2)"
date: 2017-08-19
author: conchi
categories: Malware Analysis
---


어제부터 본격적인 분석일지(라쓰고 아무말 대잔치라 읽는다)가 시작되었다.  지난글에 이어 3.4DDoS 두번째 이야기를 시작하려한다.  
<br>

지난글을 요약하자면 Host.dll이라는 파일을 분석했는데, 이 dll은 실행하면서 3개의 dll과, 4개의 dat파일을 System32 폴더안에 생성하였다.
생성된 dll들은 service로 등록시켰으며  System32\drivers\etc\hosts 파일을 변조하여 업데이트된 백신이 악성코드를 탐지하는걸 방해하게끔 만들었다. 모든 할일을 끝내고나서는 배치파일을 만들어 자가삭제하는 동작을 하는 코드들을 확인하였다.    
<br>
<br>

- 지난글 보러가기   
[> 물꼬기의 수상한 Analysis 일지 01 - 3.4 DDoS(1)](https://conchiholic.github.io/malware/analysis/2017/08/09/Analysis-diary01.html)  

오늘부터는 Host.dll에서 떨어진 바이너리들을 분석하고자 한다.  'ㅅ'/  
<br>
- - -
## sfofsvc.dll(sxxxsvc.dll)  
servicemain부터 들어가서 분석을 진행하였다. 위쪽에는 servicemain답게 서비스에 관한 동작들이 줄줄 나온다.    
한참 내리다 보면 아래쪽에서 Thread를 생성하는데, 요기에 있는 StartAddress를 타고 들어가서 내용들을 확인해보았다.  
<br>

![1](/assets/ana02/01.JPG)  
StartAddress안은 되게 심플하다. sub_1001200()(이하 time_10001200), sub_100013E0() 이렇게 두개의 함수가 존재한다. 첫번째 함수부터 뒤져보도록 했다.  
<br>

#### 01. time_10001200()  
이름은 내가 분석하면서 임의로 수정했다. 그냥 전체를 분석하고나서 걸맞는 이름을 지어주는 편인데 이 함수에서는 '공격 시간'과 관련된 일을 하는 듯 했기 때문에 이렇게 지어줬다그냥.
<br>

자세한 이야기는 다음 글에서 하게 될 듯 하다. 대충보고 넘겼는데 나중에 정리하려고 보니까 생각보다 조건문쪽을 조금 더 봐야할듯해서 'ㅅ'...a... 보류!  

#### 02. sub_100013E0()  
이놈이 사실 무서운놈이었다.  
<br>

![1](/assets/ana02/02.JPG)    
sub_100013E0()함수 안으로 들어가면 두개의 Thread를 생성하는 부분이 보인다. 하나씩 들어가서 분석을 진행하였다. 결론부터 말하자면 둘 다 뭔가를 부수는(?!) 괴팍한 기능을 가지고 있었다. 자세히 알아보도록 하자.  
<br>

**첫번째 쓰레드**
<br>

![1](/assets/ana02/03.JPG)    
시작부터 상당히 흉측하다. 내 컴퓨터에 있는 디스크를 모두 찾아버리겠다는 악성코드 제작자의 의도가 보인다. aC 에는  <%c:\> 이런 문자열이 들어있다. v1이 25인걸 감안했을때 swprintf는 이렇게 생겨먹었다.   
<br>

```{c}
swprintf(&String, "%c:\", 25+65);
```
느낌이 오는감..? ㅋㅋㅋ 90을 아스키 코드표에서 찾아보면 "Z"를 의미한다. 이런식으로 하나씩 숫자를 줄여서 대문자 "A"가 될때까지, 해당 드라이브가 내 PC에 존재하는지 체크한 후, 존재하면 sub_10001A90()함수를 실행한다.
자 그러면 해당 드라이브가 존재하면 어떤일이 일어나는지 한번 구경해보자.  
<br>

![1](/assets/ana02/04.JPG)   
파일의 확장자들을 겁나 찾아재낀다. 검색당하는 파일의 확장자를 정리해보면  다음과 같다.
<br>

> .doc, .docx, .docm, .wpd, .wpx, .wri, .xls, .xlsx, .mdb, .ppt,
.pptx, .pdf, .hwp, .hna, .gul, .kwp, .eml, .pst, .alz, .gho, .rar, .php, .asp, .aspx, .jsp, .java, .cpp, .h, .c, .zip

(hwp를 두번이나 적음 ㅋㅋ 문서 쓰다가 크래쉬 터져서 저장한거 다 날아간 경험 있는사람인가...  파괴 의지 오져따리 지려따리)  
<br>

이렇게 발견당한 파일들은 모두 0으로 덮히고(!!!) .cab라는 확장자를 달고 다시태어난다.
그런데 0으로 덮히는 과정이 그냥 무작정 0!! 이게 아니라 바이트를 쪼개서 0으로 바꾸고, 뭐 8자리의 암호를 걸어 암호화 하는거같고 막 그런 일련의 과정이 있는데 사실 이부분 보다가 오버워치하러감(....)  
이부분도 다음시간에 조금 자세히 다루는걸로!  

- - -

다음글에는 이번편에서 못다한 이야기들을 하게될 듯하다.
(mbr을 0으로 덮는 부분에 대한 이야기나 mbr 영역을 0으로 덮고, 특정한 확장자를 가진 파일들을 부수는 등의 동작에 대한 이야기)  
이야기가 길어지겠군 'ㅅ'a..
<br>

분석한거에 비해 별내용이 없어보이는게 너무 슬프다 흑흑.. ㅜㅜ..  
언제쯤이면 나도 킹갓사람들처럼 슥-삭 하면 쟈란쟈란 하는 보고서를 쓸수있게될까  
밍밍... ㅜㅜ..  
<br>
